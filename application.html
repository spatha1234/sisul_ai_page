<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI협력업체 지원 양식 - 서울시설공단</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="page-application">
    <!-- 헤더 -->
    <header>
        <nav>
            <div class="logo">
                <a href="index.html" aria-label="메인으로">
                    <img src="logo.png" alt="서울시설공단">
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html#overview">모집개요</a></li>
                <li><a href="index.html#qualifications">지원자격·절차</a></li>
                <li><a href="index.html#contact">문의처</a></li>
            </ul>
        </nav>
    </header>

    <div class="application-container">
        <div class="application-header">
            <h1>AI협력업체 지원 양식</h1>
            <p>서울시설공단 AI협력업체 모집에 지원해주셔서 감사합니다</p>
        </div>

        <form id="applicationForm">
            <!-- 기본 정보 -->
            <div class="form-section">
                <h2>기본 정보</h2>
                <div class="info-box">
                    <p>모든 필수 항목(*)은 반드시 입력해주세요.</p>
                </div>

                <div class="form-group">
                    <label class="required">회사명</label>
                    <input type="text" name="companyName" required placeholder="회사명을 입력하세요">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>대표자명</label>
                        <input type="text" name="representative" placeholder="대표자명을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label class="required">사업자등록번호</label>
                        <input type="text" name="businessNumber" required placeholder="사업자등록번호를 입력하세요">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required">담당자명</label>
                        <input type="text" name="contactPerson" required placeholder="담당자명을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>담당자 직책</label>
                        <input type="text" name="position" placeholder="예: 대표이사, 상무 등">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required">전화번호</label>
                        <input type="tel" name="phone" required placeholder="전화번호를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label class="required">이메일</label>
                        <input type="email" name="email" required placeholder="example@company.com">
                    </div>
                </div>

                <div class="form-group">
                    <label>회사 홈페이지</label>
                    <input type="text" name="website" placeholder="https://www.example.com">
                </div>
            </div>

            <!-- 협력 분야 -->
            <div class="form-section">
                <h2>협력 분야</h2>
                <div class="form-group">
                    <label class="required">주요 협력 분야</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="cooperationField" value="ai-facility" id="field1">
                            <label for="field1">AI 기반 시설 관리</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="cooperationField" value="smart-city" id="field2">
                            <label for="field2">스마트 시티 솔루션</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="cooperationField" value="data-analysis" id="field3">
                            <label for="field3">데이터 분석</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="cooperationField" value="automation" id="field4">
                            <label for="field4">자동화 시스템</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="cooperationField" value="other" id="field5">
                            <label for="field5">기타</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>기타 협력 분야 상세</label>
                    <textarea name="cooperationDetail" placeholder="기타 협력 분야가 있으시면 입력해주세요"></textarea>
                </div>
            </div>

            <!-- 회사 소개 -->
            <div class="form-section">
                <h2>회사 소개</h2>
                <div class="form-group">
                    <label class="required">회사 개요</label>
                    <textarea name="companyOverview" required placeholder="회사의 설립 목적, 주요 사업 분야, 비전 등을 입력하세요"></textarea>
                </div>

                <div class="form-group">
                    <label class="required">주요 기술 및 서비스</label>
                    <textarea name="technology" required placeholder="보유 AI 기술, 서비스, 솔루션, 실적 등을 입력하세요"></textarea>
                </div>
            </div>

            <!-- 첨부 파일 -->
            <div class="form-section">
                <h2>첨부 파일</h2>
                <div class="info-box">
                    <p>파일은 각각 20MB 이하로 업로드해주세요. (지원 형식: PDF, DOC, DOCX, JPG, PNG)</p>
                </div>

                <div class="form-group">
                    <label class="required">사업자등록증</label>
                    <div class="file-upload">
                        <input type="file" name="businessLicense" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                        <label for="businessLicense" class="file-upload-label">
                            📎 파일 선택 (필수)
                        </label>
                    </div>
                    <div class="file-list" id="fileList1"></div>
                </div>

                <div class="form-group">
                    <label>회사소개서</label>
                    <div class="file-upload">
                        <input type="file" name="companyProfile" accept=".pdf,.doc,.docx">
                        <label for="companyProfile" class="file-upload-label">
                            📎 파일 선택 (선택)
                        </label>
                    </div>
                    <div class="file-list" id="fileList2"></div>
                </div>

                <div class="form-group">
                    <label class="required">기술보유 증빙자료</label>
                    <div class="file-upload">
                        <input type="file" name="technologyProof" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                        <label for="technologyProof" class="file-upload-label">
                            📎 파일 선택 (필수)
                        </label>
                    </div>
                    <div class="file-list" id="fileList3"></div>
                </div>
            </div>

            <!-- 제출 버튼 -->
            <div class="submit-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">취소</button>
                <button type="submit" class="btn btn-primary">지원서 제출</button>
            </div>
        </form>
    </div>

    <!-- 성공 팝업 모달 -->
    <div id="successModal" class="success-modal">
        <div class="success-modal-content">
            <div class="success-icon">✅</div>
            <h3>제출 완료!</h3>
            <p>지원서가 성공적으로 제출되었습니다.<br>검토 후 연락드리겠습니다.</p>
            <button class="success-modal-button" onclick="closeSuccessModal(); window.location.href='index.html';">확인</button>
        </div>
    </div>

    <!-- 개인정보 수집·이용 동의 팝업 -->
    <div class="agree-modal-overlay" id="agreeModal">
        <div class="agree-modal">
            <h2>개인정보 수집·이용 동의서</h2>
            <div class="agree-body">
                <p>공단은 AI협력업체 등록을 위해 아래와 같이 개인정보를 수집·이용하고자 합니다. 내용을 자세히 읽으신 후 동의 여부를 결정하여 주시기 바랍니다.</p>
                <p class="agree-item"><strong>1. 개인정보의 수집·이용 목적(필수)</strong><br>민원사무 처리에 관한 법률 및 시행령, 공단 민원사무처리규정 제4조제5항에 의거하여 <span class="agree-highlight">전자민원사무</span>를 처리하는 업무</p>
                <p class="agree-item"><strong>2. 수집 항목</strong><br>필수항목 : <span class="agree-highlight">성명, 전화번호, 이메일</span></p>
                <p class="agree-item"><strong>3. 개인정보의 보유 및 이용기간</strong><br>협력업체 모집 완료 시까지 또는 내부업무 처리를 위하여 <span class="agree-highlight">1년간</span> 보유 후 삭제</p>
                <p class="agree-item"><strong>4. 동의를 거부할 권리가 있으며, 동의 거부 시 AI협력업체 등록이 불가하오니 양지하시기 바랍니다.</strong></p>
                <p style="margin-top:1rem;">※ 위와 같이 개인정보를 수집·이용하는데 동의하십니까?</p>
            </div>
            <div class="agree-checkbox-wrap">
                <label><input type="checkbox" name="agreeChoice" id="agreeYes"> 동의함</label>
                <label><input type="checkbox" name="agreeChoice" id="agreeNo"> 동의안함</label>
            </div>
            <div class="agree-modal-buttons">
                <button type="button" class="agree-btn-cancel" id="agreeModalClose">닫기</button>
                <button type="button" class="agree-btn-confirm" id="agreeConfirm">확인</button>
            </div>
        </div>
    </div>

    <!-- 푸터 -->
    <footer>
        <p>&copy; 2026 서울시설공단. All rights reserved.</p>
        <p>서울시설공단과 함께 더 나은 미래를 만들어갑니다.</p>
        <p class="footer-flaticon">Designed by UIcons from www.flaticon.com</p>
    </footer>

    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // DOM이 로드된 후 실행
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase 클라이언트 초기화
            const SUPABASE_URL = 'https://rqewmdskqkqvczjwznwm.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxZXdtZHNrcWtxdmN6and6bndtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MDgwNDIsImV4cCI6MjA4NDk4NDA0Mn0.ot8b0gU9eBNE6bAKwRIs9cL-ngAqXTZ5Xo0Pe1a_iCE';
            
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase 클라이언트를 로드할 수 없습니다.');
                alert('Supabase 클라이언트를 로드할 수 없습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const STORAGE_BUCKET = 'applications'; // Storage 버킷 이름

            // 성공 모달 표시 함수 (전역으로 설정)
            window.showSuccessModal = function() {
                const modal = document.getElementById('successModal');
                if (modal) {
                    modal.classList.add('show');
                }
            };

            // 성공 모달 닫기 함수 (전역으로 설정)
            window.closeSuccessModal = function() {
                const modal = document.getElementById('successModal');
                if (modal) {
                    modal.classList.remove('show');
                }
            };

            // 모달 외부 클릭 시 닫기
            const successModal = document.getElementById('successModal');
            if (successModal) {
                successModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        window.closeSuccessModal();
                    }
                });
            }

        // 파일 선택 시 파일명 표시
        document.querySelectorAll('input[type="file"]').forEach((input, index) => {
            input.addEventListener('change', function(e) {
                const fileList = document.getElementById(`fileList${index + 1}`);
                if (this.files && this.files.length > 0) {
                    let fileNames = [];
                    for (let i = 0; i < this.files.length; i++) {
                        const fileSize = (this.files[i].size / 1024 / 1024).toFixed(2);
                        fileNames.push(`${this.files[i].name} (${fileSize}MB)`);
                    }
                    fileList.innerHTML = fileNames.join('<br>');
                } else {
                    fileList.innerHTML = '';
                }
            });
        });

        // 파일을 Supabase Storage에 업로드
        async function uploadFile(file, applicationId, fileType) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${applicationId}/${fileType}_${Date.now()}.${fileExt}`;
            const filePath = `${fileName}`;

            const { data, error } = await supabase.storage
                .from(STORAGE_BUCKET)
                .upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (error) {
                console.error('파일 업로드 오류:', error);
                throw error;
            }

            // 파일 정보를 데이터베이스에 저장
            const { data: fileData, error: dbError } = await supabase
                .from('application_files')
                .insert({
                    application_id: applicationId,
                    file_type: fileType,
                    file_name: file.name,
                    file_path: filePath,
                    file_size: file.size,
                    mime_type: file.type
                });

            if (dbError) {
                console.error('파일 정보 저장 오류:', dbError);
                throw dbError;
            }

            return filePath;
        }

        // 폼 제출 처리 (개인정보 동의 후 제출)
        const form = document.getElementById('applicationForm');
        var agreedForSubmit = false;
        var agreeModalEl = document.getElementById('agreeModal');
        var agreeYesEl = document.getElementById('agreeYes');
        var agreeNoEl = document.getElementById('agreeNo');
        var agreeConfirmEl = document.getElementById('agreeConfirm');
        var agreeModalCloseEl = document.getElementById('agreeModalClose');

        function openAgreeModalForSubmit() {
            if (agreeYesEl) agreeYesEl.checked = false;
            if (agreeNoEl) agreeNoEl.checked = true;
            if (agreeModalEl) agreeModalEl.classList.add('show');
        }
        function closeAgreeModal() {
            if (agreeModalEl) agreeModalEl.classList.remove('show');
        }

        if (agreeConfirmEl) {
            agreeConfirmEl.addEventListener('click', function() {
                if (agreeYesEl && agreeYesEl.checked) {
                    agreedForSubmit = true;
                    closeAgreeModal();
                    if (form) form.requestSubmit();
                } else {
                    alert('개인정보 수집·이용에 동의하지 않으시면 지원서를 작성하실 수 없습니다.');
                    closeAgreeModal();
                }
            });
        }
        if (agreeModalCloseEl) agreeModalCloseEl.addEventListener('click', closeAgreeModal);
        if (agreeModalEl) {
            agreeModalEl.addEventListener('click', function(e) {
                if (e.target === agreeModalEl) closeAgreeModal();
            });
        }
        if (agreeYesEl) agreeYesEl.addEventListener('change', function() {
            if (this.checked && agreeNoEl) agreeNoEl.checked = false;
        });
        if (agreeNoEl) agreeNoEl.addEventListener('change', function() {
            if (this.checked && agreeYesEl) agreeYesEl.checked = false;
        });

        if (!form) {
            console.error('폼을 찾을 수 없습니다.');
        }
        
        form.addEventListener('submit', async function(e) {
            if (!agreedForSubmit) {
                e.preventDefault();
                e.stopPropagation();
                openAgreeModalForSubmit();
                return;
            }
            agreedForSubmit = false;

            e.preventDefault();
            e.stopPropagation();
            
            // 협력 분야 체크 확인
            const cooperationFields = document.querySelectorAll('input[name="cooperationField"]:checked');
            if (cooperationFields.length === 0) {
                alert('주요 협력 분야를 최소 1개 이상 선택해주세요.');
                return;
            }

            // 파일 크기 확인
            const fileInputs = document.querySelectorAll('input[type="file"]');
            let hasError = false;
            fileInputs.forEach(input => {
                if (input.files && input.files.length > 0) {
                    for (let i = 0; i < input.files.length; i++) {
                        const fileSize = input.files[i].size / 1024 / 1024; // MB
                        if (fileSize > 20) {
                            alert(`${input.files[i].name} 파일이 20MB를 초과합니다.`);
                            hasError = true;
                        }
                    }
                }
            });

            if (hasError) return;

            // 제출 확인
            if (!confirm('지원서를 제출하시겠습니까?\n제출 후에는 수정이 불가능합니다.')) {
                return;
            }

            // 제출 버튼 비활성화 및 로딩 표시
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '제출 중...';

            try {
                // 폼 데이터 수집
                const formData = new FormData(this);
                const cooperationFieldValues = Array.from(cooperationFields).map(field => field.value);

                // 지원서 데이터 준비 (DB NOT NULL 컬럼에는 빈 문자열 전달)
                const applicationData = {
                    company_name: formData.get('companyName'),
                    representative: formData.get('representative') || null,
                    business_number: formData.get('businessNumber'),
                    contact_person: formData.get('contactPerson'),
                    position: formData.get('position') || null,
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    website: formData.get('website') || null,
                    cooperation_fields: cooperationFieldValues,
                    cooperation_detail: formData.get('cooperationDetail') || null,
                    company_overview: formData.get('companyOverview'),
                    technology: formData.get('technology')
                };

                // 1. 지원서 정보를 데이터베이스에 저장
                const { data: application, error: appError } = await supabase
                    .from('applications')
                    .insert(applicationData)
                    .select()
                    .single();

                if (appError) {
                    console.error('지원서 저장 오류:', appError);
                    throw new Error('지원서 저장에 실패했습니다: ' + appError.message);
                }

                const applicationId = application.id;

                // 2. 파일 업로드
                const fileUploadPromises = [];

                // 사업자등록증
                const businessLicense = formData.get('businessLicense');
                if (businessLicense && businessLicense.size > 0) {
                    fileUploadPromises.push(uploadFile(businessLicense, applicationId, 'businessLicense'));
                }

                // 회사소개서 (선택)
                const companyProfile = formData.get('companyProfile');
                if (companyProfile && companyProfile.size > 0) {
                    fileUploadPromises.push(uploadFile(companyProfile, applicationId, 'companyProfile'));
                }

                // 기술보유 증빙자료 (필수)
                const technologyProof = formData.get('technologyProof');
                if (technologyProof && technologyProof.size > 0) {
                    fileUploadPromises.push(uploadFile(technologyProof, applicationId, 'technologyProof'));
                }

                // 모든 파일 업로드 대기
                await Promise.all(fileUploadPromises);

                // 폼 리셋
                this.reset();
                document.querySelectorAll('.file-list').forEach(el => el.innerHTML = '');

                // 성공 팝업 표시
                window.showSuccessModal();

            } catch (error) {
                console.error('제출 오류:', error);
                alert('제출 중 오류가 발생했습니다: ' + error.message + '\n\n다시 시도해주세요.');
            } finally {
                // 제출 버튼 다시 활성화
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });
        }); // DOMContentLoaded 종료
    </script>
</body>
</html>
